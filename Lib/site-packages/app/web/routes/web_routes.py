from flask import Blueprint, render_template, request, redirect, url_for
from app.api import api_functions

web_bp = Blueprint('web', __name__)

# Homepage Route
@web_bp.route('/')
def home():
    return render_template('home.html', title="Home")

# Customer Login Page
@web_bp.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        # Handle authentication via API
        username = request.form['username']
        password = request.form['password']
        response = api_functions.authenticate_user(username, password)
        if response['status'] == 'success':
            return redirect(url_for('web.dashboard'))
        else:
            return render_template('login.html', error="Invalid credentials.")
    return render_template('login.html', title="Login")

# Customer Dashboard
@web_bp.route('/dashboard')
def dashboard():
    # Fetch data from the API
    customer_name = "John Doe"  # Example; Replace with API call
    invoices = api_functions.get_billing_history(customer_id=1)
    chart_data = api_functions.get_service_usage(customer_id=1)
    chart_labels = ["Jan", "Feb", "Mar"]  # Replace with actual data
    return render_template('dashboard.html', customer_name=customer_name, invoices=invoices,
                           chart_data=chart_data, chart_labels=chart_labels)

# Services List
@web_bp.route('/services')
def services():
    services = api_functions.get_all_services()
    return render_template('services.html', services=services, title="Our Services")

# Subscribe to Service
@web_bp.route('/subscribe/<int:service_id>', methods=['POST'])
def subscribe(service_id):
    # Subscribe via API
    response = api_functions.subscribe_to_service(customer_id=1, service_id=service_id)
    if response['status'] == 'success':
        return redirect(url_for('web.dashboard'))
    else:
        return "Subscription failed", 400
